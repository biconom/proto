# Обновления API от 10 октября 2025

Привет! В этом документе описаны новые сервисы и изменения в моделях данных, которые были добавлены для реализации функционала обмена и внутренних переводов.

## TL;DR (Краткая сводка) - **ОБНОВЛЕНО**

- **Добавлены справочные сервисы**: `ExchangeService`, `ExchangeCurrencyPairService` для получения информации о биржах и торговых парах.
- **Добавлен сервис рыночных данных**: `MarketDataService` для получения курсов в реальном времени.
- **Добавлен торговый сервис**: `TradeService` для выполнения операций обмена (покупки/продажи).
- **Расширен сервис кошелька**: В `WalletCurrencyService` добавлен метод `Transfer` для внутренних переводов между пользователями.
- **Обновлены модели**: В `WalletTypeCurrency` добавлены настройки для внутренних переводов.

---

## 1. Новые Справочные и Рыночные Сервисы (Публичные)

Эти сервисы не требуют авторизации и предназначены для получения публичной информации. Их данные можно запрашивать при старте приложения и кэшировать.

### `ExchangeService`
- **Что это?** Сервис для получения списка доступных торговых площадок (бирж/обменников).
- **Зачем нужен?** Чтобы показать пользователю, где он может торговать (например, "Спотовый рынок", "Быстрый обмен").
- **Ключевые методы**: `List()` для получения списка всех площадок.

### `ExchangeCurrencyPairService`
- **Что это?** Сервис для получения информации о том, какие валютные пары на каких биржах торгуются, и по каким правилам.
- **Зачем нужен?** Чтобы узнать операционные настройки для пары: лимиты на сумму сделки, комиссии, активна ли пара сейчас. Эти данные нужны для валидации на клиенте и для отображения информации пользователю.
- **Ключевые методы**: `List()` с фильтрами по бирже или валютной паре.

### `TickerService` (ранее `MarketDataService`)
- **Что это?** Сервис для получения рыночных данных (курсов).
- **Зачем нужен?** Это основной источник цен.
- **Ключевые методы**:
  - `Get()` / `List()`: для получения текущего курса.
  - `Subscribe()`: **(Самый важный)** для подписки на обновления курсов в реальном времени через стрим.
- **Модель `Ticker`**: Ответ от этого сервиса. Обрати внимание на `oneof rate_kind`:
  - `exchanger_rate`: будет приходить для обменников (фиксированные цены `buy_price` и `sell_price`).
  - `market_rate`: будет приходить для полноценных бирж (цена последней сделки, объемы и т.д.).

---

## 2. Новые Торговые и Финансовые Сервисы (Приватные)

Эти сервисы требуют авторизации пользователя.

### `TradeService` (для обмена/торговли)
- **Что это?** Сервис для выполнения операций покупки/продажи в обменнике.
- **Как работает?** Используется двухэтапный подход:
  1. **`ValidateTrade(TradeRequest)`**: Метод для **предварительного расчета**. Ты отправляешь, что пользователь хочет купить/продать, а сервер в ответ присылает `TradeDetails` — сколько пользователь получит, какой будет курс и какая комиссия. **Деньги на этом этапе не списываются.** Если что-то не так (не хватает баланса, превышен лимит), метод вернет ошибку.
  2. **`CreateTrade(TradeRequest)`**: Метод для **исполнения сделки**. Принимает тот же `TradeRequest`. Вызывается, когда пользователь нажимает финальную кнопку "Подтвердить".

### `WalletCurrencyService` (добавлен метод `Transfer`)
- **Что это?** В существующий сервис добавлен метод для выполнения внутренних переводов между пользователями системы.
- **Как работает?**
  - **`Transfer(TransferRequest)`**: Выполняет перевод.
  - **В запросе `TransferRequest` нужно указать**:
    - `source`: с какого баланса (кошелек + валюта) списываем.
    - `amount`: какую сумму.
    - `recipient`: кому переводим (можно указать `account_id` или `distributor_id`).

---

## 3. Ключевые изменения в Моделях Данных

### `WalletTypeCurrency`
- **Что изменилось?** Добавлено поле `internal_transfer_settings`.
- **Зачем это верстальщику?** Внутри этой структуры лежат лимиты (`min_amount`, `max_amount`) и комиссии (`outgoing_fee`) для внутренних переводов. **Перед тем, как дать пользователю ввести сумму перевода**, нужно запросить эту модель и использовать эти данные для валидации на стороне клиента.

### Новые модели
- **`Exchange`**: Сама торговая площадка (биржа).
- **`ExchangeCurrencyPair`**: Правила торгов (лимиты, комиссии) для конкретной пары на конкретной бирже.
- **`Ticker`**: Рыночные данные (курс).

---

## 4. Примерный сценарий использования (Workflow)

### Сценарий 1: Обмен валюты
1.  При загрузке приложения получи и закэшируй данные из `DictionaryService` (он теперь содержит `exchanges` и `exchange_currency_pairs`).
2.  Пользователь выбирает в интерфейсе пару для обмена, например, BTC на USDT на площадке "Быстрый обмен".
3.  Подпишись на `TickerService.Subscribe` для этой пары, чтобы показывать актуальный курс.
4.  Пользователь вводит сумму, которую хочет потратить (например, 1000 USDT).
5.  Сформируй `TradeRequest` и вызови `TradeService.ValidateTrade`.
6.  В ответе `TradeDetails` получишь точную сумму BTC к зачислению и детализацию комиссий. Покажи это пользователю.
7.  Пользователь нажимает "Обменять".
8.  Вызови `TradeService.CreateTrade` с тем же `TradeRequest`. Готово.

### Сценарий 2: Внутренний перевод
1.  Пользователь хочет перевести USDT со своего спотового кошелька.
2.  Получи данные для этой связки через `WalletTypeCurrencyService.Get({ wallet_type_id: SPOT, currency_id: USDT })`.
3.  Из ответа возьми `internal_transfer_settings` и проверь лимиты (`min_amount`, `max_amount`) для введенной пользователем суммы. Покажи ему комиссию.
4.  Пользователь вводит ID получателя и сумму.
5.  Сформируй `TransferRequest` и вызови `WalletCurrencyService.Transfer`. Готово.