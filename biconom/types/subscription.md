# Модель: Subscription (Подписки)

## 1. Описание

**`Subscription`** — это иерархическая модель данных, предназначенная для управления лицензиями и их тарифными планами в рамках системы подписок. Она позволяет группировать различные варианты оплаты (планы) вокруг конкретного типа лицензии.

## 2. Структура модели

Модель построена по принципу вложенности для обеспечения логической связности:

### 2.1. Subscription (Корень)
Агрегирующая модель, которая связывает одну **License** (техническое право) и список доступных для неё **Plans** (коммерческие условия). Используется для отображения "витрины" подписок.

### 2.2. License (Лицензия)
Представляет собой право на использование конкретного функционала или сущности (например, "Slot License").
- `id`: Уникальный идентификатор лицензии.
- `title`: Человекочитаемое название.
- `metadata`: Гибкое поле для хранения бизнес-атрибутов лицензии, необходимых в конкретном бизнес-контексте.

### 2.3. Plan (Тарифный план)
Описывает конкретные условия подписки на лицензию.
- `license_id`: Ссылка на родительскую лицензию (часть составного ключа).
- `plan_id`: Локальный идентификатор плана внутри лицензии.
- `duration`: Длительность расчетного периода в секундах (например, 2592000 для 30 дней).
- `price`: Стоимость, выраженная через универсальную модель `Price` (валюта + сумма).
- `metadata`: Поле для хранения дополнительных бизнес-параметров плана, определяющих логику его применения.

### 2.4. Subscription.State (Состояние биллинга)
Описывает коммерческий статус подписки пользователя.
- `status`: Статусы оплаты (`ACTIVE`, `PAST_DUE` — просрочка, `TRIALING` — триал, `CANCELED`, `UNPAID`).
- `is_auto_renew_enabled`: Флаг автоматического продления.
- `next_billing_at`: Дата следующей попытки списания средств.

## 3. Поле Metadata: Концепция и использование

Поля `metadata` в лицензиях и планах предназначены для расширения бизнес-модели без изменения основной схемы данных. Они хранят атрибуты, специфичные для конкретного бизнес-процесса или маркетингового контекста.

**Рекомендации:**
1. **Формат**: Рекомендуется использовать JSON-строку.
2. **Назначение**: Используйте это поле для хранения параметров, влияющих на бизнес-логику (например, коэффициенты начислений, условия квалификации, специфические триггеры). Это поле **не предназначено** для чисто оформительских данных (цвета, иконки), которые должны управляться на уровне CMS или фронтенд-конфигураций.
3. **Пример**: `{"bonus_multiplier": 1.5, "required_rank": "gold", "auto_upgrade_target": 102}`.

## 4. Сценарии использования

### Сценарий 1: Отображение витрины
Метод `ListSubscriptionPlans` возвращает `Subscription.List`. Фронтенд итерирует по лицензиям, отрисовывает заголовки, а внутри выводит карточки тарифов, используя `price` и `duration`.

### Сценарий 2: Покупка подписки
При оформлении подписки клиент отправляет составной `Subscription.Plan.Id` (`license_id` + `plan_id`). Система инициирует платеж и обновляет `Subscription.State` и `License.State`.

## 5. Связи с другими моделями

- **`Price`**: Используется внутри `Plan` для обеспечения точности финансовых расчетов.
- **`MarketingService`**: Основной потребитель модели для управления доступом к аффилейт-маркетингу.
- **`License.State`**: Техническое отражение прав, полученных через подписку.

## 6. Технические особенности

- **Идентификация**: Используются составные идентификаторы (`license_id` + `plan_id`), что исключает применение плана к неверному типу лицензии.
- **Списки**: Каждая сущность поддерживает вложенное сообщение `List` для пакетной передачи данных.
- **Временные интервалы**: Поле `duration` в секундах обеспечивает максимальную точность и позволяет настраивать любые периоды — от почасовых до многолетних подписок.

---
*Документация актуальна для версии proto-файлов от 17 января 2026 г.*
