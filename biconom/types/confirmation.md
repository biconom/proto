# Модель: Confirmation

## 1. Описание

**`Confirmation`** — это мощная и гибкая модель, представляющая собой одноразовую, защищенную сессию для подтверждения пользователем важного действия (например, вывод средств, смена пароля).

Архитектура модели позволяет создавать сложные формы с несколькими полями (пароль, 2FA, код из email) и даже с альтернативными наборами полей для подтверждения (например, "пароль + 2FA" **или** "код из email").

## 2. Назначение и решаемые задачи

Основная цель — унифицировать и обезопасить процесс подтверждения критически важных операций.

### Ключевые задачи:
- **Безопасность**: Обеспечивает многофакторное подтверждение.
- **Гибкость**: Позволяет создавать формы любой сложности с помощью полей `Field` и механизма группировки через битовые маски.
- **Управление жизненным циклом**: Четко отслеживает состояние сессии через `Status` (`ACTIVE`, `APPROVED`, `REJECTED`, `CANCELLED`, `EXPIRED`).
- **Управление через политики**: Поведение формы (время жизни, лимиты попыток) определяется на бэкенде политикой, связанной с действием.

## 3. Ключевые поля и концепции

- `action_name`: Уникальное имя действия (например, "WITHDRAWAL"), которое позволяет бэкенду понять, какую логику выполнять после успешного подтверждения.
- `status`: Текущий статус сессии.
- `expires_at`: Точное время, когда форма станет просроченной.
- `fields`: Список всех полей, которые **могут** быть использованы для верификации.

### Концепция группировки полей через битовые маски

Вместо жестких групп используется гибкая система битовых масок:
- Каждому полю `Field` присваивается `group_bit_mask`. Это число, являющееся степенью двойки (1, 2, 4, 8, ...).
- Поля, которые должны использоваться вместе (логическое "И"), имеют одинаковую битовую маску.
- Поля, которые являются альтернативой друг другу (логическое "ИЛИ"), имеют разные битовые маски.
- Для успешного подтверждения формы пользователю необходимо предоставить валидные значения для всех полей из **одной** из групп (т.е. для одного из значений `group_bit_mask`).

## 4. Вложенные сообщения

- **`Field`**: Описывает одно поле для верификации (`PASSWORD`, `CHANEL`, `GOOGLE_AUTHENTICATOR_CODE` и т.д.).
- **`Form.Request` и `Form.Response`**: Определяют структуру для отправки данных пользователем и получения детального ответа о статусе проверки каждого поля.

## 5. Сценарии использования (кейсы)

- **Вывод средств (Пароль + 2FA)**:
  1. Создается `Confirmation` с `action_name: "WITHDRAWAL"`.
  2. Создаются два поля `Field`:
     - Поле для пароля с `group_bit_mask: 1`.
     - Поле для кода 2FA с `group_bit_mask: 1`.
  3. Пользователь должен заполнить оба поля для подтверждения.

- **Смена email (Пароль ИЛИ Код из email)**:
  1. Создается `Confirmation` с `action_name: "CHANGE_EMAIL"`.
  2. Создаются два поля `Field`:
     - Поле для пароля с `group_bit_mask: 1`.
     - Поле для кода из email с `group_bit_mask: 2`.
  3. Пользователь может подтвердить действие, заполнив **либо** пароль, **либо** код из email.

## 6. Связи с другими моделями

- **`ConfirmationPolicy`**: `Confirmation` **управляется** логикой соответствующей политики на бэкенде, которая определяет ее параметры (время жизни, лимиты попыток и т.д.).
