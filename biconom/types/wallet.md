# Модель: Wallet

## 1. Описание

**`Wallet`** — это модель, представляющая собой конкретный экземпляр кошелька, который принадлежит одному владельцу (`Account`). Он создается на основе шаблона `WalletType` и является контейнером для набора счетов (`Ledger`), где хранятся активы пользователя.

## 2. Назначение и решаемые задачи

Основная цель модели — служить персональным кошельком для пользователя, позволяя при этом применять индивидуальные настройки и ограничения поверх глобальных правил, заданных в `WalletType`.

### Ключевые задачи:
- **Владение**: Четко привязывает кошелек к конкретному `Account` через поле `account_id`.
- **Индивидуальное состояние**: Позволяет управлять состоянием кошелька одного пользователя независимо от других. Поля `status` и `disabled_operations_flags` дают возможность заморозить кошелек или точечно отключить операции для одного конкретного пользователя.
- **Агрегация счетов**: Содержит список связей `WalletLedger`, которые указывают на фактические счета (`Ledger`), где хранятся средства.

## 3. Ключевые поля и иерархия статусов

- `id`, `account_id`, `wallet_type_id`: Основные идентификаторы, связывающие кошелек с его владельцем и типом.
- `ledgers`: Список ссылок на `Ledger`, по одной для каждой валюты в кошельке.
- `status`: **Индивидуальный статус** этого экземпляра кошелька. Позволяет администратору заморозить (`FROZEN`) кошелек одного пользователя, не затрагивая других.
- `disabled_operations_flags`: **Индивидуальные запреты**. Битовая маска, позволяющая принудительно запретить операции для этого конкретного кошелька, даже если они разрешены на уровне `WalletType`.

### Важно: Иерархическая проверка доступности операций

Чтобы определить, доступна ли операция, клиентское приложение **обязано** учитывать всю иерархию статусов и флагов. Проверка должна выполняться в следующем порядке:

1.  **Проверка статуса экземпляра `Wallet`**:
    - Если `Wallet.status` равен `FROZEN`, все операции **запрещены**. Дальнейшие проверки не требуются.

2.  **Проверка статуса родительского `WalletType`**:
    - Если `Wallet.status` равен `ACTIVE`, необходимо получить родительский `WalletType` (по `wallet_type_id`) и проверить его статус.
    - Если `WalletType.status` равен `MAINTENANCE` или `RETIRED`, все операции также **запрещены**.

3.  **Проверка флагов операций**:
    - Только если статусы на обоих уровнях (`Wallet` и `WalletType`) активны, можно переходить к проверке флагов. Итоговая маска разрешений вычисляется на сервере, но логика такова: операция разрешена, если она есть в `WalletType.allowed_operations_flags` и ее **нет** ни в `WalletTypeCurrency.disabled_operations_flags`, ни в `Wallet.disabled_operations_flags`.

## 4. Сценарии использования

- **Создание кошелька для пользователя**: При регистрации или по запросу для `Account` создается экземпляр `Wallet` на основе `WalletType` "SPOT". Кошелек наследует все разрешения от типа.
- **Блокировка кошелька пользователя**: Служба безопасности обнаружила подозрительную активность. Администратор находит нужный `Wallet` по `account_id` и меняет его `status` на `FROZEN`. Все операции для этого пользователя немедленно блокируются, но другие пользователи продолжают работать как обычно.

## 5. Связи с другими моделями

- **`Account`**: `Wallet` **принадлежит** одному `Account` (связь через `account_id`).
- **`WalletType`**: `Wallet` **является экземпляром** одного `WalletType` (связь через `wallet_type_id`).
- **`WalletLedger`**: `Wallet` **содержит** список `WalletLedger`, которые, в свою очередь, ссылаются на `Ledger`.
- **`WalletOperation`**: `Wallet` **логически использует** перечисление `WalletOperation.Id` для определения позиций битов в поле `disabled_operations_flags`.