syntax = "proto3";

package biconom.types;

import "google/protobuf/any.proto";
import "google/protobuf/timestamp.proto";
import "biconom/types/confirmation_policy.proto";

// Confirmation представляет собой одноразовую форму или сессию для подтверждения важного действия.
message Confirmation {
	// --- Вложенные типы и сообщения ----

	// Статус формы подтверждения.
	enum Status {
		UNSPECIFIED = 0;
		// Форма активна и ожидает подтверждения.
		PENDING = 1;
		// Форма была успешно подтверждена.
		APPROVED = 2;
		// В верификации было отказано (например, исчерпаны попытки).
		REJECTED = 3;
		// Форма была отменена пользователем или системой.
		CANCELLED = 4;
		// Срок действия формы истек.
		EXPIRED = 5;
	}

	// Описание одного поля для верификации.
	message Field {
		// Типы полей, которые могут потребоваться для подтверждения.
		enum Kind {
			UNSPECIFIED = 0;
			// Код, отправленный на канал связи (например, email).
			CHANEL = 1;
			// Пароль от аккаунта пользователя.
			PASSWORD = 2;
			// Чекбокс для подтверждения согласия с условиями.
			AGREEMENT_CHECKBOX = 3;
			// Код из приложения 2FA Google Authenticator.
			GOOGLE_AUTHENTICATOR_CODE = 4;
		}

		// Детали генерации кодов для каналов связи.
		message Chanel {
			// Типы контактного канала, на который отправляется код.
			enum Kind {
				UNSPECIFIED = 0;
				EMAIL = 1;
			}
			Kind chanel_kind = 1;	                            // Тип канала связи (email, sms и т.д.).
			string chanel_contact = 2;	                        // Значение канала связи (например, email адрес).
			uint32 generation_duration = 3;	                    // Интервал между попытками генерации нового кода (в секундах).
			google.protobuf.Timestamp last_generated_at = 4;	// Время генерации последнего кода.
			uint32 generation_attempt_limit = 5;				// Лимит доступных попыток генерации нового кода.
			uint32 generation_attempts_made = 6;				// Количество уже сделанных попыток генерации.
		}

		uint32 id = 1;										// Уникальный ID поля в рамках формы.
		uint32 group_bit_mask = 2;							// Битовая маска для группировки полей.
		Kind kind = 3;	    								// Тип поля (пароль, 2FA, чекбокс и т.д.).
		optional Chanel chanel = 4;							// Детали генерации кода для канала связи.
	}

	// Идентификатор для поиска формы.
	message Id {
		uint64 id = 1; // Глобальный ID формы.
	}

	// Список форм подтверждения.
	message List {
		repeated Confirmation items = 1;
	}

	// ---- Сообщения для Запросов и Ответов ----

	// Запрос на генерацию одноразового кода для поля.
	message GenerateCodeRequest {
		uint64 confirmation_id = 1;			// ID формы подтверждения.
		uint32 field_id = 2;				// ID поля, для которого нужно сгенерировать код.
	}

	// Запрос на подтверждение формы.
	message Form {
		message Request {
			// Поле, предоставленное пользователем для верификации.
			message Field {
				uint32 field_id = 1; // ID поля, которое заполняет пользователь.
				oneof value {
					string string_value = 2;	// Значение для полей типа пароль, код и т.д.
					bool bool_value = 3;		// Значение для чекбокса (должно быть `true`).
				}
			}

			uint64 confirmation_id = 1; // Глобальный ID формы для подтверждения.
			repeated Field fields = 2; // Список полей, которые отправляет пользователь.
		}

		// Ответ на запрос подтверждения формы.
		message Response {
			// Общий статус ответа на запрос подтверждения.
			enum Status {
				UNSPECIFIED = 0;
				// Форма успешно подтверждена.
				APPROVED = 1;
				// Форма отклонена (одно или несколько полей неверны).
				REJECTED = 2;
			}

			// Результат проверки для одного поля.
			message Field {
				// Детальный статус для каждого отдельного поля.
				enum Status {
					UNSPECIFIED = 0;
					// Поле заполнено верно.
					OK = 1;
					// Поле не заполнено, но является обязательным.
					EMPTY = 2;
					// Поле заполнено неверно.
					WRONG = 3;
					// Пользователь не согласился с условиями (чекбокс не `true`).
					NOT_AGREED = 4;
				}
				uint32 field_id = 1;					// ID проверенного поля.
				Status status = 2;				    	// Статус проверки этого поля.
			}

			message Metadata {
				oneof identifier {
					string comment = 1;
				}
			}

			Status status = 1;		        			// Общий статус подтверждения.
			repeated Field fields = 2;	            	// Детальный результат по каждому полю.
			optional Metadata metadata = 3;		        // Дополнительные данные, возвращаемые при успехе.
		}
	}

	message Metadata {
		oneof identifier {
			string Google_Authenticator_secret = 1;
		}
	}

	// ---- Поля основного сообщения Confirmation ----

	uint64 id = 1;
	uint32 account_id = 2;									// ID аккаунта, который инициировал действие.
	string action_name = 3;									// Уникальное имя действия (например, "WITHDRAWAL").
	Status status = 4;

	uint32 verification_attempt_limit = 5;					// Лимит попыток верификации для этой формы
	uint32 verification_attempts_made = 6;					// Количество сделанных попыток верификации.

	repeated Field fields = 7;                              // Список всех доступных полей для этой формы.
	optional uint32 approved_group_bit_mask = 8;            // Битовая маска для групп полей, которые были успешно подтверждены.

	uint64 trace_id = 9;
	uint32 policy_id = 10;									// Политика, управляющая правилами (время жизни, лимиты попыток).
	google.protobuf.Timestamp created_at = 11;
	google.protobuf.Timestamp expires_at = 12;				// Точное время, когда форма станет недействительной (рассчитывается на основе политики).
	google.protobuf.Timestamp updated_at = 13;
	optional Metadata metadata = 14;                        // Гибкое поле для дополнительных данных.
}
