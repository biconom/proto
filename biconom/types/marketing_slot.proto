syntax = "proto3";

package biconom.types;

import "biconom/types/slot.proto";
import "biconom/types/distributor.proto";
import "biconom/types/account.proto";
import "biconom/types/subscription.proto";
import "biconom/types/price.proto";
import "biconom/types/license.proto";
import "google/protobuf/timestamp.proto";

// MarketingSlot представляет собой агрегированную модель данных маркетингового слота.
message MarketingSlot {
    message List {
        repeated MarketingSlot items = 1;
    }
    message DistributorState {
        message TreeState {
            uint32 tree_id = 1;
            uint32 slots_for_placement_count = 2; // Количество слотов, ожидающих ручной расстановки
            uint32 slots_for_compression_count = 3; // Количество слотов, которые могут подняться за счёт компрессии
        }
        uint32 distributor_id = 1;
        repeated TreeState tree_states = 2;
    }

    // State содержит динамическую информацию о состоянии слота и лицензии.
    message State {
        message List {
            repeated State items = 1;
        }
        uint32 slot_id = 1;
        uint32 distributor_id = 2; // Идентификатор дистрибьютора, владеющего слотом
        biconom.types.License.State license_state = 3;      // Техническое право доступа
        biconom.types.Subscription.State subscription_state = 4; // Состояние оплаты/биллинга
        uint32 tree_id = 5; // Идентификатор дерева, к которому относится слот
        bool placement_required = 6; // Нуждается ли слот в расстановке
        google.protobuf.Timestamp placement_deadline_at = 7; // Дедлайн ручной расстановки; после этого момента сработает автоматическая
        optional google.protobuf.Timestamp placement_executed_at = 8; // Когда по факту произошла расстановка слота в иерархии
    }

    // Chain представляет собой цепочку (ответвление) в структуре маркетинга.
    message Chain {
        uint32 parent_branch_number = 1;
        repeated uint32 slot_ids = 2; // Массив ID слотов, входящих в цепочку

        message Income {
            uint32 bonus_id = 1;
            biconom.types.Price value = 2; // Сумма дохода
        }
        repeated Income incomes = 3;
    }

    // Breadcrumb описывает элемент пути навигации (хлебную крошку).
    message Breadcrumb {
        uint32 parent_branch_number = 1;
        uint32 slot_id = 2; // Выбранный слот в цепочке
        repeated uint32 slot_ids = 3; // Список всех ID слотов, относящихся к цепочке
    }

    uint32 executor_slot_id = 1;
    uint32 view_slot_id = 2; // Идентификатор просматриваемого слота в иерархии
    uint32 tree_id = 9; // Идентификатор дерева, в котором находятся слоты (executor_slot_id и view_slot_id принадлежат этому дереву)
    repeated Breadcrumb breadcrumbs = 3; // Путь (хлебные крошки) между executor и view
    repeated Chain view_chains = 4; // Структура дочерних цепочек для view_slot_id
    repeated State slot_states = 5; // Список состояний для интересующих слотов
    repeated biconom.types.Slot slots = 6; // Все связанные слоты
    repeated biconom.types.Distributor distributors = 7; // Дистрибьюторы, владеющие слотами
    repeated biconom.types.Account accounts = 8; // Аккаунты, владеющие дистрибьюторами
    repeated DistributorState distributor_states = 10; // Состояния дистрибьюторов
}
