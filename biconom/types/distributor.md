# Модель: Distributor

## 1. Описание

**`Distributor`** — это ключевая модель, представляющая участника, узел или партнера в одной из иерархических сетей (`Network`). Эту сущность можно рассматривать как "бизнес-единицу" или "партнерский узел", который может строить свою собственную структуру.

## 2. Назначение и решаемые задачи

Модель `Distributor` предназначена для построения и управления партнерскими и многоуровневыми сетями.

### Ключевые задачи:
- **Множественная идентификация**: Дистрибьютора можно найти по множеству уникальных ключей: глобальный `id`, `username`, а также по составным идентификаторам в контексте сети, аккаунта или родителя (см. вложенное сообщение `Id`).
- **Построение иерархии**: Поля `parent_id`, `parent_entity_id` и `parent_branch_id` позволяют выстраивать древовидную структуру.
- **Владение**: `account_id` связывает дистрибьютора с его владельцем — `Account`.
- **Отслеживание метрик структуры**: Поля `level`, `children_quantity`, `structure_quantity` и `structure_level_max` предоставляют готовую статистику по структуре дистрибьютора.
- **Определение иерархической связи**: Поле `relationship_state` динамически рассчитывается на сервере и показывает, в каком иерархическом отношении находится данный дистрибьютор к текущему аутентифицированному пользователю.
- **Управление через политики**: `policy_id` позволяет применять к дистрибьютору централизованно управляемые правила.

## 3. Ключевые поля и концепции

- `id`: Уникальный глобальный идентификатор.
- `username`: Необязательное, но уникальное человекочитаемое имя.
- `invite_code`: Уникальный код, используемый для прямой привязки к этому дистрибьютору.
- `account_id`: Связывает дистрибьютора с его владельцем — `Account`.
- `network_id`: Указывает, к какой глобальной сети (`Network`) принадлежит этот дистрибьютор.
- `parent_id`: Определяет иерархию, указывая на вышестоящего дистрибьютора.
- `level`: Глобальный уровень глубины дистрибьютора в иерархии.
- `policy_id`: Обязательное поле, связывающее дистрибьютора с его политикой.
- `relationship_state`: Необязательное поле, которое **заполняется на сервере** для каждого запроса. Оно описывает иерархическую связь между данным дистрибьютором и **текущим аутентифицированным пользователем**. Например, оно покажет, является ли этот дистрибьютор частью команды пользователя (`TEAM`), его вышестоящим спонсором (`UPLINE`) или находится в боковой ветке (`SIDEWAYS`).

### Контекстные идентификаторы
Помимо глобального `id`, существует несколько `*_entity_id`, которые являются уникальными в рамках определенного контекста:
- `account_entity_id`: Уникальный ID дистрибьютора в рамках одного `account_id`.
- `network_entity_id`: Уникальный ID дистрибьютора в рамках одной `network_id`.
- `parent_entity_id`: Уникальный ID дистрибьютора в рамках одного `parent_id`.

## 4. Сценарии использования (кейсы)

- **Регистрация нового партнера**: В системе создается `Distributor`, ему присваивается `parent_id` и рассчитываются все остальные идентификаторы и метрики.
- **Отображение структуры**: Данные `level`, `children_quantity` и `structure_quantity` используются для быстрого построения визуального представления партнерской сети без сложных запросов.

## 5. Связи с другими моделями

- **`Account`**: `Distributor` **принадлежит** одному `Account`.
- **`Network`**: `Distributor` **является частью** одной `Network`.
- **`DistributorPolicy`**: `Distributor` **управляется** одной политикой.
