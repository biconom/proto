# Модель: Ledger

## 1. Описание

**`Ledger`** — это фундаментальная модель, представляющая собой атомарный бухгалтерский счет. Она является ядром финансовой системы, используется для учета одного конкретного типа актива (`Asset`) и принадлежит определенному владельцу (`Owner`).

## 2. Назначение и решаемые задачи

Основная цель — обеспечить точный и надежный учет активов с помощью принципа двойной записи. `Ledger` не хранит "текущий баланс" напрямую. Вместо этого он разделяет учет на несколько состояний:
- **Проведенные операции** (`posted_debit`, `posted_credit`): средства, которые уже списаны или зачислены. "Бухгалтерский" баланс вычисляется как `posted_credit - posted_debit`.
- **Ожидающие операции** (`pending_debit`, `pending_credit`): средства, заблокированные под операцию, которая ожидает внешнего подтверждения (например, в блокчейне).
- **Запланированные операции** (`scheduled_debit`, `scheduled_credit`): операции, которые будут выполнены в будущем.

### Ключевые задачи:
- **Владение**: Четко определяет, кому принадлежит счет (`Owner`), будь то кошелек, пул организации или платежная сеть.
- **Атомарный учет**: Каждый `Ledger` отвечает только за один тип актива.
- **Неизменяемость истории**: Суммы `posted_credit` и `posted_debit` могут только увеличиваться, что обеспечивает целостность и аудируемость.
- **Гибкое управление**: Поведение счета регулируется через `status` и набор флагов (`flags`).

## 3. Ключевые поля и концепции

- `id`: Уникальный идентификатор счета. Может быть представлен как числовым `id` (`uint64`), так и составным ключом `ByOwnerAsset` ("владелец + актив"), что гарантирует уникальность счета для каждого владельца по каждому активу.
- `owner`: Определяет владельца счета. Это может быть кошелек, пул организации или системный счет платежной сети.
- `asset`: Определяет, какой именно актив (`Currency` или `Inventory`) учитывается на этом счете.
- `posted_debit`, `posted_credit`: Основа бухгалтерского учета. Суммы проведенных операций.
- `pending_debit`, `pending_credit`: Суммы "замороженных" средств, ожидающих подтверждения.
- `scheduled_debit`, `scheduled_credit`: Суммы запланированных будущих операций.
- `status`: **Ключевое поле**. Определяет жизненный цикл счета (`ACTIVE`, `FROZEN`, `SUSPENDED`, `CLOSED`). Статус имеет приоритет над флагами. Например, если `status = FROZEN`, никакие операции невозможны, даже если флаги их разрешают.
- `initialized`: Флаг, который показывает, был ли объект счета создан в системе (`true`) или является значением по умолчанию (`false`). Это помогает клиентам отличать реальные счета от "пустых" шаблонных объектов.
- `flags`: Битовая маска, которая предоставляет гранулярный контроль над поведением счета, когда он находится в статусе `ACTIVE`.
  - `ALLOW_NEGATIVE`: Разрешает уходить в минус без ограничений.
  - `LIMIT_NEGATIVE`: Разрешает минус в пределах `credit_limit`.
  - `ALLOW_OVERDRAFT_LIMIT`: Разрешает минус в пределах `overdraft_limit`.
  - `ALLOW_DEBIT` / `ALLOW_CREDIT`: Разрешают списания и зачисления.
  - `LOCKED`: Временно блокирует новые транзакции по операционным причинам.
  - `FROZEN_FLAG`: Полная заморозка счета при инцидентах.
  - `SUSPICIOUS`: Помечает счет как подозрительный для дополнительной проверки.

## 4. Сценарии использования

- **Создание счета для пользователя**: При создании кошелька для пользователя для каждой валюты создается свой `Ledger` с `status = ACTIVE` и стандартным набором флагов.
- **Заморозка счета**: Служба безопасности обнаружила подозрительную активность. Администратор меняет `status` счета на `FROZEN`. Все новые транзакции по этому счету блокируются на уровне системы.
- **Закрытие счета**: При закрытии аккаунта пользователя его счета `Ledger` переводятся в `status = CLOSED` после того, как баланс был обнулен.
- **Кредитная линия**: Для счета устанавливается флаг `LIMIT_NEGATIVE` и заполняется поле `credit_limit`, что позволяет пользователю уходить в минус на согласованную сумму.

## 5. Связи с другими моделями

- **`Asset`**: `Ledger` **содержит** один `Asset`, определяя, что он учитывает.
- **`LedgerTransaction`**: Транзакции **оперируют** счетами `Ledger`, изменяя их балансовые показатели.
- **`WalletCurrency`**: `Ledger` **является частью** `WalletCurrency`, предоставляя ему фактические данные о балансе.