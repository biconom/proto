# Модель: Ledger

## 1. Описание

**`Ledger`** — это фундаментальная модель, представляющая собой атомарный бухгалтерский счет. Она является ядром финансовой системы и используется для учета одного конкретного типа актива (`Asset`).

## 2. Назначение и решаемые задачи

Основная цель — обеспечить точный и надежный учет активов с помощью принципа двойной записи. `Ledger` не хранит "текущий баланс" напрямую. Вместо этого он хранит общую сумму всех зачислений (`credit_total`) и всех списаний (`debit_total`). Текущий баланс всегда вычисляется как `credit_total - debit_total`.

### Ключевые задачи:
- **Атомарный учет**: Каждый `Ledger` отвечает только за один тип актива.
- **Неизменяемость истории**: Суммы `credit_total` и `debit_total` могут только увеличиваться, что обеспечивает целостность и аудируемость.
- **Гибкое управление**: Поведение счета регулируется через `status` и набор флагов (`flags`).

## 3. Ключевые поля и концепции

- `asset`: Определяет, какой именно актив (`Currency` или `Inventory`) учитывается на этом счете.
- `credit_total`, `debit_total`: Основа бухгалтерского учета. Хранятся как строки для поддержки высокой точности.
- `status`: **Ключевое поле**. Определяет жизненный цикл счета (`ACTIVE`, `FROZEN`, `SUSPENDED`, `CLOSED`). Статус имеет приоритет над флагами. Например, если `status = FROZEN`, никакие операции невозможны, даже если флаги их разрешают.
- `flags`: Битовая маска, которая предоставляет гранулярный контроль над поведением счета, когда он находится в статусе `ACTIVE`.
  - `ALLOW_DEBIT`: Разрешает списания.
  - `ALLOW_CREDIT`: Разрешает зачисления.
  - `ALLOW_NEGATIVE`: Разрешает балансу уходить в минус.

## 4. Сценарии использования

- **Создание счета для пользователя**: При создании кошелька для пользователя для каждой валюты создается свой `Ledger` с `status = ACTIVE` и стандартным набором флагов.
- **Заморозка счета**: Служба безопасности обнаружила подозрительную активность. Администратор меняет `status` счета на `FROZEN`. Все новые транзакции по этому счету блокируются на уровне системы.
- **Закрытие счета**: При закрытии аккаунта пользователя его счета `Ledger` переводятся в `status = CLOSED` после того, как баланс был обнулен.

## 5. Связи с другими моделями

- **`Asset`**: `Ledger` **содержит** один `Asset`, определяя, что он учитывает.
- **`LedgerTransaction`**: Транзакции **оперируют** счетами `Ledger`, изменяя их `credit_total` и `debit_total`.
- **`WalletBalance`**: `Ledger` **является частью** `WalletBalance`, предоставляя ему фактические данные о балансе.