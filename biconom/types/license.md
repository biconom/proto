# Модель: License (Лицензии)

## 1. Описание

**`License`** — это модель, представляющая техническое право пользователя на использование конкретного функционала или сущности в системе (например, маркетингового слота). Она отделена от процесса оплаты (биллинга) и фокусируется на проверке прав доступа.

## 2. Структура модели

### 2.1. License (Сущность)
- `id`: Уникальный идентификатор типа лицензии.
- `title`: Название (например, "Slot License").
- `metadata`: JSON-строка с бизнес-атрибутами, определяющими логику работы лицензии (например, коэффициенты начислений).

### 2.2. License.State (Состояние)
Описывает текущий статус владения лицензией для конкретного объекта (слота).
- `license_id` & `plan_id`: Составной идентификатор, указывающий, на каких условиях (по какому плану) была получена текущая лицензия.
- `status`: Текущий технический статус (см. ниже).
- `is_trial`: Флаг пробного периода.

## 3. Статусы лицензии

- **`INACTIVE`**: Лицензия никогда не активировалась или была деактивирована.
- **`ACTIVE`**: Лицензия оплачена и предоставляет полный доступ.
- **`EXPIRED`**: Срок действия истек, доступ заблокирован.
- **`GRACE_PERIOD`**: Срок действия истек, но система предоставляет временный доступ ("окно лояльности") для решения проблем с оплатой.
- **`SUSPENDED`**: Доступ заблокирован административно (например, за нарушение правил), независимо от оплаты.

## 4. Временные метки (Timestamps)

Правильная интерпретация дат критична для логики продления:

- **`activated_at`**: Момент самой первой активации лицензии для данного объекта. Не меняется при продлениях. Позволяет вычислять "стаж" владения.
- **`started_at`**: Дата начала **текущего** оплаченного периода. Обновляется при каждом продлении.
- **`expires_at`**: Дата окончания текущего периода. После этой даты лицензия переходит в `GRACE_PERIOD` или `EXPIRED`.
- **`grace_period_expires_at`**: Крайняя точка "окна лояльности". Если до этого момента оплата не поступит, доступ будет полностью прекращен.
- **`last_activated_at`**: Момент последнего фактического применения лицензии (например, когда отложенный ваучер вступил в силу).

## 5. Взаимодействие с другими моделями

- **`Subscription.Plan`**: Лицензия выдается на основании выбранного тарифного плана.
- **`MarketingService`**: Использует `License.State` для проверки возможности начисления бонусов и активности слота в структуре.

## 6. Рекомендации по использованию

1. **Проверка доступа**: Для предоставления услуг всегда проверяйте `status`. Доступ разрешен, если статус `ACTIVE` или `GRACE_PERIOD`.
2. **Metadata**: Используйте это поле для хранения параметров, которые бэкенд должен учитывать при расчетах (например, `{"max_depth": 10}`).

---
*Документация актуальна для версии proto-файлов от 17 января 2026 г.*