# Модель: PaymentNetworkCurrencyWithdrawal

## 1. Описание

**`PaymentNetworkCurrencyWithdrawal`** — это модель, представляющая собой заявку пользователя на вывод средств из системы. Она инкапсулирует все данные, необходимые для выполнения вывода, и отслеживает его жизненный цикл с помощью статусов.

## 2. Структура и назначение

Модель имеет вложенную структуру для разделения ответственности:

- **`PaymentNetworkCurrencyWithdrawal` (внешняя модель)**: Представляет собой уже созданную в системе заявку. Она содержит системные поля:
  - `id`: Уникальный идентификатор заявки.
  - `status`: Текущий статус жизненного цикла (`PENDING_CONFIRMATION`, `PROCESSING`, `COMPLETED` и т.д.).
  - `transaction_id`: Ссылка на основную финансовую транзакцию, созданную после успешной обработки заявки.
  - `created_at` / `updated_at`: Временные метки.

- **`Body` (внутренняя модель)**: Содержит данные, которые предоставляет пользователь при создании заявки. Эта модель может быть переиспользована в запросах на создание, так как она не содержит системных полей.
  - `payment_network_id` и `currency_id`: Указывают, какую валюту и через какую платежную сеть выводить.
  - `wallet_type_id`: Указывает, с какого кошелька необходимо списать средства.
  - `instrument`: "Сырые" реквизиты получателя (например, адрес кошелька). Это поле обязательно.
  - `optional payment_destination_id`: Ссылка на запись в "адресной книге" пользователя. Если это поле заполнено, это означает, что вывод идет на адрес из "белого списка". Если нет — это одноразовый вывод.
  - `amount`: Сумма вывода.
  - `memo`: Опциональное поле `memo/tag`, если оно требуется для сети.
  - `deduct_fee_from_amount`: Флаг, определяющий, как обрабатывается комиссия.
    - `true`: `amount` — это общая сумма списания, а получатель получит `amount - fee`.
    - `false` (по умолчанию): `amount` — это "чистая" сумма для получателя, а с баланса будет списано `amount + fee`.
  - `add_to_whitelist`: Флаг, указывающий, что реквизиты (`instrument`) нужно сохранить в "белый список" (адресную книгу) после успешного вывода.
  - `new_destination_name`: Имя для новой записи в адресной книге. Должно быть заполнено, если `add_to_whitelist` равно `true`.

## 3. Сценарий использования

1.  Пользователь хочет вывести средства. Клиентское приложение собирает данные и формирует объект `PaymentNetworkCurrencyWithdrawal.Body`.
2.  Этот объект отправляется на бэкенд в метод создания заявки.
3.  Бэкенд создает новую запись `PaymentNetworkCurrencyWithdrawal`, присваивает ей `id` и начальный статус `PENDING_CONFIRMATION`, и вкладывает в нее полученный `Body`.
4.  Далее, по мере прохождения заявки по своему жизненному циклу (подтверждение, обработка, отправка), бэкенд обновляет ее `status` и другие поля.

## 4. Связи с другими моделями

- **`WalletType`**: `PaymentNetworkCurrencyWithdrawal.Body` **ссылается** на эту модель через `wallet_type_id` для определения кошелька-источника.
- **`PaymentNetwork` и `Currency`**: `PaymentNetworkCurrencyWithdrawal.Body` **ссылается** на эти модели через `payment_network_id` и `currency_id`.
- **`PaymentInstrument`**: `PaymentNetworkCurrencyWithdrawal.Body` **всегда содержит** эту модель для определения реквизитов получателя.
- **`PaymentDestination`**: `PaymentNetworkCurrencyWithdrawal.Body` может **опционально ссылаться** на эту модель через `payment_destination_id` для указания, что вывод идет на адрес из "белого списка".
- **`Transaction`**: `PaymentNetworkCurrencyWithdrawal` **ссылается** на эту модель через `transaction_id` после успешного создания финансовых проводок.