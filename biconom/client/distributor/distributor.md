# Сервис: DistributorService

## 1. Описание

**`DistributorService`** — это клиентский сервис, который предоставляет инструменты для получения информации о дистрибьюторах (`Distributor`). Он позволяет как получать конкретных дистрибьюторов по их идентификаторам, так и выполнять поиск.

## 2. Описание методов (RPC)

### `rpc Get(biconom.types.Distributor.Id) returns (Response)`
- **Назначение**: Получить полную информацию о конкретном дистрибьюторе, а также связанные с ним данные (аккаунт-владелец) за один запрос.
- **Использование**: Позволяет клиенту запросить данные дистрибьютора, используя его глобальный `id`, `username` или любой другой составной ключ, определенный в `biconom.types.Distributor.Id`.

### `rpc ListPartners(ListPartnersRequest) returns (ListResponse)`
- **Назначение**: Получить список дистрибьюторов вместе со связанными аккаунтами-владельцами. В зависимости от параметров, метод может вернуть либо список дистрибьюторов, принадлежащих **текущему аутентифицированному пользователю**, либо список их прямых партнеров (первую линию).
- **Использование**:
  - Без `parent_id`: для отображения списка "моих дистрибьюторов" в личном кабинете.
  - С `parent_id`: для просмотра первой линии конкретного дистрибьютора.
- **Параметры `ListPartnersRequest`**:
  - `optional uint32 parent_id`: Фильтрует дистрибьюторов, чтобы получить только прямых потомков указанного родителя.
  - `optional biconom.types.Distributor.Id cursor`: Курсор для пагинации.
  - `optional biconom.types.Sort sort`: Параметры сортировки и лимита.
  - `optional uint32 executor_upline_visibility_depth`: Глубина видимости иерархии вышестоящих, разрешенная для авторизованного пользователя (`executor_distributor_id`). Значение по умолчанию `0` означает, что авторизованный пользователь является самым верхним видимым дистрибьютором.
  - `optional uint32 upline_limit`: Ограничивает общее количество возвращаемых вышестоящих дистрибьюторов для `view_distributor_id`. Если поле отсутствует, ограничение не применяется. Если значение равно `0`, вышестоящие не возвращаются.

### `rpc Search(SearchRequest) returns (SearchResponse)`
- **Назначение**: Выполнить поиск дистрибьюторов по префиксу их `username` с расширенными фильтрами.
- **Использование**: Полезно для реализации автодополнения (autocomplete) при поиске дистрибьюторов по имени с учетом их сети и иерархического положения.
- **Параметры `SearchRequest`**:
  - `string username_prefix`: Префикс имени пользователя для поиска.
  - `optional uint32 limit`: Ограничение на количество возвращаемых результатов.
  - `optional uint32 network_id`: Фильтр для поиска только в одной указанной сети. Если не указан, поиск идет по всем доступным сетям.
  - `repeated biconom.types.Relationship.State.Kind filter_relationship_state_kinds`: Фильтр по типу иерархической связи. Позволяет искать, например, только в своей команде (`TEAM`) и среди вышестоящих (`UPLINE`). Если поле пусто, фильтр не применяется.

### `rpc GetStructureOverview(GetStructureOverviewRequest) returns (GetStructureOverviewResponse)`
- **Назначение**: Получить агрегированную статистику по структуре указанного дистрибьютора, сгруппированную по уровням глубины.
- **Использование**: Позволяет быстро оценить размер и состав структуры, не загружая полный список всех участников. Полезно для дашбордов и аналитических отчетов.
- **Параметры `GetStructureOverviewRequest`**:
  - `optional biconom.types.Distributor.Id distributor_id`: ID дистрибьютора, для которого запрашивается состояние структуры.
  - `optional uint32 level_limit`: Ограничивает глубину статистики. Если не указан, возвращаются все уровни. Если `0`, статистика по уровням не возвращается.
  - `optional uint32 distributors_per_group_limit`: Ограничивает количество последних дистрибьюторов, возвращаемых в каждой группе (как в общей, так и в каждой уровневой).

## 3. Общие структуры ответов

### `Response`
Ответ для одиночной сущности, который включает в себя:
- `distributor`: Найденный дистрибьютор.
- `account`: Связанный аккаунт-владелец.

### `ListResponse`
Ответ для списка сущностей, который помимо основного результата (`distributors` и `accounts`) содержит богатый иерархический контекст относительно текущего пользователя:
- `distributors`: Список найденных дистрибьюторов.
- `accounts`: Список связанных аккаунтов-владельцев.
- `executor_distributor_id`: ID дистрибьютора, который выполняет запрос (авторизованный пользователь). Позволяет клиенту понять, "кто я".
- `view_distributor_id`: ID дистрибьютора, чья структура просматривается в данный момент (актуально для `ListPartners`).
- `partner_ids`: Список ID прямых партнеров (`первой линии`) для `view_distributor_id`.
- `upline_ids`: Список ID всей вышестоящей спонсорской линии для `view_distributor_id`.

### `GetStructureOverviewResponse`
Ответ со сводной статистикой по структуре, который содержит:
- `total`: Общая статистика по всей структуре (общее количество и список ID последних дистрибьюторов).
- `levels`: Список статистики по каждому уровню в глубину.
- `accounts`: Дедуплицированный список аккаунтов-владельцев для всех возвращенных дистрибьюторов.
- `distributors`: Дедуплицированный список дистрибьюторов, на которые ссылаются `distributor_ids` в группах.
