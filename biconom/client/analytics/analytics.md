# Сервис: AnalyticsService

## 1. Описание

**`AnalyticsService`** — это клиентский сервис, предназначенный для получения аналитических данных в виде графиков. Он предоставляет гибкий и унифицированный интерфейс для запроса различных типов диаграмм (например, доход, регистрации) с возможностью глубокой настройки области видимости данных и временных интервалов.

## 2. Ключевые концепции

### Идентификация графика

Система различает два типа графиков по комбинации полей в запросе `GetChartRequest`:
- **`custom_id` (опционально)**: Произвольный строковый идентификатор, который клиент может установить для связи запроса с ответом. Сервер вернет это же значение в модели `Chart`.
- **Количественный график**: Запрашивается только по `chart_name` (например, `chart_name: "registrations"`).
- **Монетарный (денежный) график**: Запрашивается по `chart_name` и `currency_id` (например, `chart_name: "income", currency_id: 123`).

### Область видимости (`ScopeOptions`)

Параметр `scope` позволяет точно определить, чьи данные должны быть включены в отчет.
- **`PERSONAL`**: Только персональные данные аутентифицированного пользователя.
- **`TEAM`**: Данные по команде (структуре) пользователя. Этот режим имеет дополнительные настройки:
  - `team_depth_limit`: Позволяет ограничить глубину структуры для отчета (например, `3` — только первые три уровня). Если не указан, включается вся структура.
  - `include_personal`: Флаг, который определяет, нужно ли включать в командный отчет данные самого пользователя.
- **`COMPANY_WIDE`**: Данные по всей компании. Доступно только пользователям с соответствующими правами.

### Запрос данных по временному диапазону

Сервис позволяет запрашивать данные за произвольный временной диапазон. Сервер автоматически сегментирует этот диапазон на "свечи" в соответствии с указанным интервалом (`interval`) и часовым поясом.

- **`timestamp_start`**: Временная метка Unix, определяющая начало периода.
- **`timestamp_end`**: Временная метка Unix, определяющая конец периода.

## 3. Описание методов (RPC)

### `rpc GetChart(GetChartRequest) returns (biconom.types.Chart)`
- **Назначение**: Получить один график по его идентификатору и параметрам.
- **Использование**: Основной метод для запроса данных для одного графика. Клиент формирует `GetChartRequest`, указывая все необходимые параметры: идентификатор, область видимости, интервал и, при необходимости, курсор для пагинации.
- **Ответ**: Возвращает один объект `biconom.types.Chart`, содержащий все данные для отображения.

### `rpc GetCharts(GetChartRequest.List) returns (biconom.types.Chart.List)`
- **Назначение**: Получить несколько графиков за один пакетный запрос.
- **Использование**: Идеально подходит для дашбордов, где нужно одновременно отобразить несколько графиков. Это позволяет избежать множественных сетевых запросов.
- **Запрос**: Принимает `GetChartRequest.List`, который содержит список `items` — отдельных запросов `GetChartRequest` для каждого графика.
- **Ответ**: Возвращает `biconom.types.Chart.List`, содержащий список объектов `biconom.types.Chart`. Порядок графиков в ответе соответствует порядку запросов.

## 4. Примерный сценарий использования (Workflow)

**Задача**: Отобразить на дашборде два графика:
1.  Личный доход в USDT за последний месяц, сгруппированный по дням.
2.  Количество регистраций в команде на глубину 5 уровней за последний месяц, сгруппированное по неделям (с понедельника).

**Решение**:

1.  Клиент формирует два объекта `GetChartRequest`:
    -   **Запрос 1 (Доход)**:
        -   `chart_name`: "income"
        -   `currency_id`: (ID для USDT)
        -   `scope`: `{ id: PERSONAL }`
	-   `interval`: `{ id: DAY, timezone_offset_seconds: 10800 }`
	-   `timestamp_start`: (Unix timestamp начала месяца)
	-   `timestamp_end`: (Unix timestamp конца месяца)

    -   **Запрос 2 (Регистрации)**:
        -   `chart_name`: "registrations"
        -   `scope`: `{ id: TEAM, team_depth_limit: 5, include_personal: true }`
        -   `interval`: `{ id: WEEK_MONDAY_START, timezone_offset_seconds: 10800 }`
        -   `timestamp_start`: (Unix timestamp начала месяца)
        -   `timestamp_end`: (Unix timestamp конца месяца)

2.  Оба запроса упаковываются в `GetChartRequest.List`:
    ```
    {
      items: [ (Запрос 1), (Запрос 2) ]
    }
    ```

3.  Клиент вызывает метод `AnalyticsService.GetCharts`, передавая этот пакетный запрос.

4.  Сервер возвращает `biconom.types.Chart.List` с двумя объектами `Chart`, готовыми для отображения.