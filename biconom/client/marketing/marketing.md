# Сервис: MarketingService

## 1. Описание

**`MarketingService`** — это основной сервис для работы с аффилейт-маркетингом. Он предназначен для управления маркетинговыми слотами, отслеживания структуры (цепочек), мониторинга доходов и управления жизненным циклом лицензий и подписок.

## 2. Методы сервиса (RPC)

### Работа со слотами
- **`GetOwnSlots`**: Возвращает список всех слотов текущего пользователя с их кратким состоянием (`State`). Используется для построения дашборда со списком активов.
- **`GetOwnSlot`**: Возвращает полную информацию о конкретном слоте. Идентификатор слота передается в заголовках (headers). Ответ включает в себя состояние, структуру цепочек и связанные данные для отображения.

### Управление подписками
- **`ListSubscriptionPlans`**: Возвращает объект `Subscription`, содержащий описание системной маркетинговой лицензии и список доступных тарифных планов.
- **`PurchaseSubscriptionPlan`**: Позволяет приобрести или активировать пробный период для лицензии. Возвращает обновленный объект `MarketingSlot`.
- **`DeactivateAutoRenewal` / `RestoreAutoRenewal`**: Управление флагом автоматического продления подписки. Возвращают актуальное состояние биллинга и лицензии.

## 3. Основные модели данных

### 3.1. MarketingSlot
Центральная модель (агрегат), содержащая всю информацию для отрисовки интерфейса слота:
- **`state`**: Динамические данные (статусы, сроки).
- **`chains`**: Список структурных ответвлений (цепочек) слота.
- **`slots`, `distributors`, `accounts`**: Списки связанных сущностей. Эти данные предоставляются для "гидратации" интерфейса, позволяя клиенту отобразить дерево и владельцев без дополнительных запросов к другим сервисам.

### 3.2. MarketingSlot.State
Объединяет два критически важных аспекта владения слотом:
- **`license_state`**: Техническое право на участие в маркетинге (активна ли лицензия, не истек ли срок).
- **`subscription_state`**: Коммерческое состояние (оплачена ли подписка, когда следующий платеж).
- **`pending_manual_placement_count`**: Количество дочерних элементов, которые ожидают ручной расстановки пользователем.

### 3.3. MarketingSlot.Chain
Описывает "ветку" или "ногу" в маркетинговой структуре:
- **`parent_branch_number`**: Номер ветки относительно родителя.
- **`slot_ids`**: Список ID слотов, находящихся в этой цепочке.
- **`incomes`**: Массив накопленного дохода, детализированный по типам бонусов и валютам (использует модель `Price`).

## 4. Жизненный цикл и логика работы

### Идентификация
Метод `GetOwnSlot` спроектирован для работы в контексте выбранного слота. Вместо передачи ID в теле запроса, клиент должен передать его в метаданных (headers), что упрощает интеграцию с middleware и системами авторизации.

### Покупка и Trial
При вызове `PurchaseSubscriptionPlan`:
1. Если `is_trial = true`, система проверяет поле `trial_supported` в плане.
2. После успешной операции `License.State` получит флаг `is_trial = true`, а `Subscription.State` перейдет в статус `TRIALING`.
3. По завершении триала или при прямой покупке статус подписки меняется на `ACTIVE`, а флаг `is_trial` сбрасывается.

### Состояние Grace Period
Если оплата подписки не прошла, `Subscription.State` может перейти в `PAST_DUE`, при этом `License.State` перейдет в `GRACE_PERIOD`. Это позволяет пользователю сохранять доступ к маркетинговым функциям в течение ограниченного времени, пока решается проблема с платежом.

## 5. Рекомендации для Frontend

1. **Отображение дерева**: Используйте массивы `slots` и `distributors` из ответа `MarketingSlot` для построения визуальной структуры. Это избавляет от проблемы N+1 запросов.
2. **Форматирование сумм**: Для отображения доходов в `Chain.incomes` используйте `precision` из справочника валют, так как `Price.amount` передается в виде строки для сохранения точности.
3. **Статусы**: Всегда проверяйте `license_state.status`. Если он отличен от `ACTIVE` или `GRACE_PERIOD`, функционал маркетинга для данного слота должен быть ограничен.

## 6. Связи с типами (biconom.types)

- **`License.State`**: Технический статус доступа.
- **`Subscription.State`**: Статус биллинга и автопродления.
- **`Price`**: Формат денежных значений.
- **`Slot`, `Distributor`, `Account`**: Базовые сущности системы.

---
*Документация актуальна для версии proto-файлов от 17 января 2026 г.*