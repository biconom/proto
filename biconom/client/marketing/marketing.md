# Сервис: MarketingService

## 1. Описание

**`MarketingService`** — это основной сервис для работы с аффилейт-маркетингом. Он предназначен для управления маркетинговыми слотами, отслеживания структуры (цепочек), мониторинга доходов и управления жизненным циклом лицензий и подписок.

## 2. Методы сервиса (RPC)

### Работа со слотами
- **`ListOwnSlotStates`**: Возвращает список состояний всех слотов текущего пользователя. Используется для построения дашборда со списком активов и их статусами.
- **`GetSlot`**: Возвращает полную информацию о выбранном слоте по его идентификатору. Ответ включает в себя состояние, структуру цепочек и связанные данные для отображения.

### Управление подписками
- **`ListSubscriptionPlans`**: Возвращает объект `Subscription`, содержащий описание системной маркетинговой лицензии и список доступных тарифных планов.
- **`PurchaseSubscriptionPlan`**: Позволяет приобрести лицензию. Возвращает обновленный объект `MarketingSlot`.
- **`DeactivateAutoRenewal` / `RestoreAutoRenewal`**: Управление флагом автоматического продления подписки для конкретного слота. Идентификатор слота передается в заголовках (headers). Возвращают актуальное состояние биллинга и лицензии.

## 3. Основные модели данных

### 3.1. MarketingSlot
Центральная модель (агрегат), содержащая всю информацию для отрисовки интерфейса слота:
- **`executor_slot_id`**: Идентификатор слота исполнителя (авторизованного пользователя).
- **`view_slot_id`**: Идентификатор слота, который просматривается в данный момент.
- **`breadcrumbs`**: Список промежуточных слоев иерархии (путь) между исполнителем и просматриваемым слотом.
- **`view_chains`**: Список дочерних цепочек для `view_slot_id`.
- **`slot_states`**: Список состояний (`State`) для слотов, упомянутых в ответе.
- **`slots`, `distributors`, `accounts`**: Списки связанных сущностей для "гидратации" интерфейса.

### 3.2. MarketingSlot.State
Объединяет два критически важных аспекта владения слотом:
- **`distributor_id`**: Идентификатор дистрибьютора, владеющего слотом.
- **`license_state`**: Техническое право на участие в маркетинге (активна ли лицензия, не истек ли срок).
- **`subscription_state`**: Коммерческое состояние (оплачена ли подписка, когда следующий платеж).
- **`pending_manual_placement_count`**: Количество дочерних элементов, которые ожидают ручной расстановки пользователем.

### 3.3. MarketingSlot.Chain
Описывает "ветку" или "ногу" в маркетинговой структуре:
- **`parent_branch_number`**: Номер ветки относительно родителя.
- **`slot_ids`**: Список ID слотов, находящихся в этой цепочке.
- **`incomes`**: Массив накопленного дохода, детализированный по типам бонусов и валютам (использует модель `Price`).

### 3.4. MarketingSlot.Breadcrumb
Описывает вышестоящую иерархию:
- **`parent_branch_number`**: Идентификатор ветки.
- **`slot_id`**: Идентификатор выбранного слота в этой ветке.
- **`slot_ids`**: Полный список слотов, входящих в данную родительскую цепочку.

## 4. Жизненный цикл и логика работы

### Идентификация
Метод `GetSlot` принимает `biconom.types.Slot.Id`. Это позволяет клиенту запрашивать данные любого доступного ему слота в иерархии для детального просмотра или навигации.

### Покупка
При вызове `PurchaseSubscriptionPlan`:
1. Клиент передает составной идентификатор плана (`license_id` + `license_entity_id`). После успешной операции `License.State` и `Subscription.State` переходят в статус `ACTIVE`.

### Состояние Grace Period
Если оплата подписки не прошла, `Subscription.State` может перейти в `PAST_DUE`, при этом `License.State` перейдет в `GRACE_PERIOD`. Это позволяет пользователю сохранять доступ к маркетинговым функциям в течение ограниченного времени, пока решается проблема с платежом.

## 5. Рекомендации для Frontend

1. **Отображение дерева**: Используйте массивы `slots`, `distributors` и `slot_states` из ответа `MarketingSlot` для построения визуальной структуры. Сопоставление состояния со слотом происходит по полю `slot_id`.
2. **Форматирование сумм**: Для отображения доходов в `view_chains.incomes` используйте `precision` из справочника валют, так как `Price.amount` передается в виде строки для сохранения точности.
3. **Статусы**: Всегда проверяйте `license_state.status`. Если он отличен от `ACTIVE` или `GRACE_PERIOD`, функционал маркетинга для данного слота должен быть ограничен.

## 6. Связи с типами (biconom.types)

- **`License.State`**: Технический статус доступа.
- **`Subscription.State`**: Статус биллинга и автопродления.
- **`Price`**: Формат денежных значений.
- **`MarketingSlot`**: Агрегированная модель данных маркетингового слота.
- **`Slot`, `Distributor`, `Account`**: Базовые сущности системы.

---
*Документация актуальна для версии proto-файлов от 18 января 2026 г.*