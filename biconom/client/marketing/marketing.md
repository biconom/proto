# Сервис: MarketingService

## 1. Описание

**`MarketingService`** — это основной сервис для работы с аффилейт-маркетингом. Он предназначен для управления маркетинговыми слотами, отслеживания структуры (цепочек), мониторинга доходов и управления жизненным циклом лицензий и подписок.

## 2. Методы сервиса (RPC)

### Контекст авторизации: `distributor_id`

Методы, требующие авторизации от имени дистрибьютора.

- **`ListOwnSlotStates`**: Возвращает список состояний всех слотов текущего дистрибьютора. Используется для построения дашборда со списком активов и их статусами.
- **`GetLicensePlan`**: Возвращает конкретный тарифный план по идентификатору (`License.Plan.Id` → `tree_id`).
- **`ListLicensePlans`**: Возвращает список доступных тарифных планов лицензии (`License.Plan.List`).
- **`PurchaseLicensePlan`**: Приобретает тарифный план лицензии. Принимает `tree_id` (дерево) и `quantity` (количество ваучеров). Возвращает обновлённое состояние слота (`MarketingSlot.State`).
- **`ListPendingManualPlacementSlots`**: Возвращает список слотов, ожидающих ручной расстановки. Опционально принимает `distributor_id` и `tree_id` для фильтрации.
- **`ListPotentialCompressionSlots`**: Возвращает список потенциальных слотов, которые могут попасть к дистрибьютору благодаря компрессии неактивных уровней снизу. Опционально принимает `tree_id` для фильтрации.

Оба метода (`ListPendingManualPlacementSlots` и `ListPotentialCompressionSlots`) возвращают единый тип `ListUnplacedSlotsResponse`, содержащий список `UnplacedSlot` (с `slot_id` и `auto_placement_at`) и связанные данные для обогащения интерфейса.

### Контекст авторизации: `slot_id`

Методы, требующие авторизации от имени конкретного слота.

- **`GetSlot`**: Возвращает полную информацию о выбранном слоте по его идентификатору. Ответ включает в себя состояние, структуру цепочек и связанные данные для отображения.
- **`DeactivateAutoRenewal` / `RestoreAutoRenewal`**: Управление флагом автоматического продления подписки для текущего слота. Возвращают актуальное состояние биллинга и лицензии.
- **`SearchSlots`**: Осуществляет поиск слотов в иерархии по префиксу логина дистрибьютора-владельца. Поддерживает гибкую фильтрацию:
  - **`filter_distributor_relationship_state_kinds`**: Фильтр по реферальной связи (например, искать владельцев, которые находятся в вашей личной команде дистрибьюторов).
  - **`filter_slot_relationship_state_kinds`**: Фильтр по маркетинговой связи (например, искать слоты, которые находятся в вашей маркетинговой структуре).
  Также поддерживает ограничение глубины поиска (вверх/вниз) для обоих типов иерархий:
  - **`filter_distributor_depth_limit_up` / `filter_distributor_depth_limit_down`**: Ограничение глубины поиска по иерархии дистрибьюторов (спонсоры/команда).
  - **`filter_slot_depth_limit_up` / `filter_slot_depth_limit_down`**: Ограничение глубины поиска по иерархии слотов (аплайны/структура).
  - **`tree_ids`**: Фильтр по идентификаторам деревьев (маркетинговых структур).
  Возвращает плоский список слотов и связанных сущностей.
- **`CalculateCapacityUpgradePrice`**: Рассчитывает стоимость увеличения количества мест в первой линии (`children_capacity`) до указанного целевого значения.
- **`PurchaseCapacityUpgrade`**: Осуществляет покупку дополнительных мест в первой линии. Возвращает обновленный объект `biconom.types.Slot`.
- **`CalculateManualPlacementPrice`**: Универсальный метод для предпросмотра и расчета стоимости расстановки.
  - Если `target_location` не передан: работает как предпросмотр автоматической расстановки. Возвращает место (`target_parent_id`), куда система поставит слот бесплатно, и цену=`0`.
  - Если `target_location` передан: рассчитывает стоимость (`price`) установки слота именно в это выбранное место.
  В обоих случаях ответ содержит контекст (дерево) целевого места для визуализации. Использует `ManualPlacementRequest`.
- **`PurchaseManualPlacement`**: Осуществляет фактическую операцию расстановки слота. Использует те же аргументы (`ManualPlacementRequest`), что и метод расчета цены. Если выбранное место требует оплаты (не совпадает с автоматическим прогнозом), средства будут списаны с баланса. Возвращает `biconom.types.MarketingSlot` расставленного слота.

## 3. Основные модели данных

### 3.1. MarketingSlot
Центральная модель (агрегат), содержащая всю информацию для отрисовки интерфейса слота:
- **`tree_id`**: Идентификатор дерева, в котором находятся слоты.
- **`executor_slot_id`**: Идентификатор слота исполнителя (авторизованного пользователя).
- **`view_slot_id`**: Идентификатор слота, который просматривается в данный момент.
- **`breadcrumbs`**: Список промежуточных слоёв иерархии (путь) между исполнителем и просматриваемым слотом.
- **`view_chains`**: Список дочерних цепочек для `view_slot_id`.
- **`slot_states`**: Список состояний (`State`) для слотов, упомянутых в ответе.
- **`slots`, `distributors`, `accounts`**: Списки связанных сущностей для гидратации интерфейса.

### 3.2. MarketingSlot.State
Объединяет критически важные аспекты владения слотом:
- **`distributor_id`**: Идентификатор дистрибьютора, владеющего слотом.
- **`tree_id`**: Идентификатор дерева, к которому относится слот.
- **`license_state`**: Техническое право на участие в маркетинге.
- **`subscription_state`**: Коммерческое состояние (оплачена ли подписка, когда следующий платеж).
- **`pending_manual_placement_count`**: Количество дочерних элементов, ожидающих ручной расстановки.
- **`placement_required`**: Флаг, указывающий, что слот нуждается в расстановке.
- **`placement_deadline_at`**: Дедлайн ручной расстановки; после него сработает автоматическая.
- **`placement_executed_at`**: Фактическое время расстановки (заполняется после размещения).

### 3.3. MarketingSlot.Chain
Описывает \"ветку\" или \"ногу\" в маркетинговой структуре:
- **`parent_branch_number`**: Номер ветки относительно родителя.
- **`slot_ids`**: Список ID слотов, находящихся в этой цепочке.
- **`incomes`**: Массив накопленного дохода, детализированный по типам бонусов и валютам (использует модель `Price`).

### 3.4. MarketingSlot.Breadcrumb
Описывает вышестоящую иерархию:
- **`parent_branch_number`**: Идентификатор ветки.
- **`slot_id`**: Идентификатор выбранного слота в этой ветке.
- **`slot_ids`**: Полный список слотов, входящих в данную родительскую цепочку.

## 4. Жизненный цикл и логика работы

### Идентификация
Метод `GetSlot` принимает `biconom.types.Slot.Id`. Это позволяет клиенту запрашивать данные любого доступного ему слота в иерархии для детального просмотра или навигации.

### Покупка
При вызове `PurchaseLicensePlan`:
1. Клиент передаёт идентификатор плана (`tree_id`). После успешной операции `License.State` и `Subscription.State` переходят в статус `ACTIVE`.
2. При повторной покупке создаются дополнительные ваучеры, которые автоматически продлевают период действия лицензии.

## 5. Рекомендации для Frontend

1. **Отображение дерева**: Используйте массивы `slots`, `distributors` и `slot_states` из ответа `MarketingSlot` для построения визуальной структуры. Сопоставление состояния со слотом происходит по полю `slot_id`.
2. **Форматирование сумм**: Для отображения доходов в `view_chains.incomes` используйте `precision` из справочника валют, так как `Price.amount` передается в виде строки для сохранения точности.
3. **Статусы**: Всегда проверяйте `license_state.status`. Если он отличен от `ACTIVE`, функционал маркетинга для данного слота должен быть ограничен.

## 6. Связи с типами (biconom.types)

- **`License.State`**: Технический статус доступа.
- **`Subscription.State`**: Статус биллинга и автопродления.
- **`Price`**: Формат денежных значений.
- **`MarketingSlot`**: Агрегированная модель данных маркетингового слота.
- **`Slot`, `Distributor`, `Account`**: Базовые сущности системы.

---
*Документация актуальна для версии proto-файлов от 16 февраля 2026 г.*