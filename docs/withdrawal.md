# Руководство: Вывод средств

В этом документе подробно описан полный цикл операции вывода средств — от проверки возможности вывода до создания и подтверждения заявки.

## 1. Сущности, необходимые для работы

Для реализации вывода вам понадобятся следующие модели и сервисы:

- **`PaymentNetworkCurrency`**: Ключевая модель, которая определяет, можно ли вывести валюту (`Currency`) через определенную платежную сеть (`PaymentNetwork`). Содержит все настройки для вывода в `withdraw_settings`.
- **`PaymentOperationSettings`**: Встраиваемая часть `PaymentNetworkCurrency`. Содержит:
    - `enabled`: Флаг, разрешен ли вывод.
    - `min_amount` / `max_amount`: Лимиты на сумму вывода.
    - `fee`: Ссылка на `CalculationGroup` для расчета комиссии.
- **`CalculationGroup`**: Модель, описывающая, как именно рассчитывается комиссия. Она может быть простой (процент + фикс) или сложной (многоуровневой).
- **`PaymentDestination`**: Запись в "адресной книге" ("белом списке") пользователя. Хранит реквизиты для многократного использования.
- **`PaymentInstrument`**: "Сырые" реквизиты получателя (например, адрес кошелька и его формат). Используется как в `PaymentDestination`, так и при создании заявки на новый адрес.
- **`PaymentNetworkCurrencyWithdrawal.Body`**: Тело запроса на создание заявки на вывод. Содержит всю информацию от пользователя: сумму, реквизиты, способ уплаты комиссии и т.д.
- **`WalletCurrencyService`**: Сервис, содержащий метод `CreateWithdrawal` для инициации вывода.
- **`WalletCurrencyService`**: Сервис, содержащий методы для управления выводом (`WithdrawalGetStatus`, `WithdrawalCalculateFee`, `WithdrawalCreate`).
- **`Confirmation`**: Форма подтверждения, которую возвращает `CreateWithdrawal`. Пользователь должен заполнить ее для завершения операции.
- **`ConfirmationService`**: Сервис для работы с формой `Confirmation` (отправка кодов, подтверждение).

---

## 2. Кейс: Как узнать, можно ли вывести средства?

Перед тем как отображать пользователю кнопку "Вывести", клиентское приложение должно проверить, разрешена ли эта операция.

**Шаг 1: Получить статус сервиса вывода**

Вызовите метод `WalletCurrencyService.WithdrawalStateGet`, передав `wallet_type_id`, `payment_network_id` и `currency_id`.

**Шаг 2: Проверить ответ**

Проверьте поле `status` в ответе. Если оно `AVAILABLE`, вывод возможен. Если `MAINTENANCE` или `DISABLED`, покажите пользователю соответствующее сообщение. Если `TIME_RESTRICTED`, покажите, когда вывод станет доступен (из поля `available_at`).

Вы также можете использовать поле `last_active_destination` из ответа, чтобы по умолчанию подставить последний использованный адрес в форму вывода.

---

## 3. Кейс: Как получить список реквизитов из "белого списка"?

Если пользователь хочет вывести средства на ранее сохраненный адрес, вам нужно показать ему отфильтрованный список его адресной книги.

**Шаг 1: Получить поддерживаемые форматы адресов для вывода**

Из справочника `PaymentNetworkCurrency` возьмите поле `network_settings.blockchain.supported_address_formats`. Это массив форматов, которые валидны для выбранной сети (например, `[EVM_HEX]` для Ethereum или `[BASE58]` для Tron).

**Шаг 2: Получить отфильтрованный список адресов**

Вызовите метод `PaymentDestinationService.List`, передав в `blockchain_formats` список форматов, полученный на предыдущем шаге. Также установите `include_archived: false`, чтобы получить только активные адреса.

Сервер вернет уже отфильтрованный список `PaymentDestination`, который можно сразу отображать пользователю для выбора.

**Шаг 3 (опционально):** Если на шаге проверки статуса вы получили `last_active_destination`, вы можете подсветить или выбрать по умолчанию этот адрес в полученном списке.

---

## 4. Кейс: Вывод на новый, не сохраненный адрес

Если пользователь вводит новый адрес, который он не хочет или не может сохранить в "белый список", используется следующий сценарий.

**Шаг 1: Собрать данные от пользователя**

Пользователь вводит:
- Сумму (`amount`).
- Адрес получателя (`instrument.address`).
- Memo/Tag, если требуется (`memo`).

**Шаг 2: Сформировать тело запроса `PaymentNetworkCurrencyWithdrawal.Body`**

Заполните объект `PaymentNetworkCurrencyWithdrawal.Body`. Ключевые поля:

- `payment_network_id`, `currency_id`, `wallet_type_id`: Указывают, откуда, что и через какую сеть выводить.
- `instrument`: Здесь вы формируете объект `PaymentInstrument`, указывая введенный пользователем адрес. **Важно**: поле `address_format` в `instrument` должно быть заполнено корректно. Клиент должен сам определить формат адреса или дать пользователю выбор.
- `amount`: Сумма.
- `memo`: Если требуется.
- `deduct_fee_from_amount`: Флаг, как считать комиссию (см. кейс 6).
- `add_to_whitelist`: `false`, так как это разовый вывод.

**Шаг 3: Вызвать `WithdrawalCreate`**

Отправьте сформированный объект в метод `WalletCurrencyService.WithdrawalCreate`. В ответ вы получите `Confirmation`, которую нужно будет подтвердить.

---

## 5. Кейс: Как корректно считать комиссию?

Теперь для расчета комиссии существует специальный метод, что значительно упрощает логику на клиенте.
 
**Шаг 1: Собрать данные**
Вам нужны `payment_network_id`, `currency_id`, `amount`, который ввел пользователь, и выбранный им режим уплаты комиссии (`deduct_fee_from_amount`).
 
**Шаг 2: Вызвать метод расчета**
Отправьте эти данные в метод `PaymentNetworkCurrencyService.CalculateWithdrawalFee`.
 
**Шаг 3: Отобразить результат**
Сервер вернет детализацию комиссии в виде карты `fee_breakdown` и итоговую сумму к получению `amount_to_receive`. Клиент может либо показать пользователю общую сумму комиссии (просуммировав значения из карты), либо полную детализацию.

---

## 6. Кейс: Как указать режим уплаты комиссии?

За способ списания комиссии отвечает флаг `deduct_fee_from_amount` в теле запроса `PaymentNetworkCurrencyWithdrawal.Body`.

### `deduct_fee_from_amount: false` (поведение по умолчанию)

- **Описание**: "Чистая" сумма для получателя.
- **Логика**: Пользователь указывает в поле `amount` сумму, которую должен получить конечный адресат. Комиссия будет списана **сверх** этой суммы с баланса пользователя.
- **Пример**: `amount` = 100 USDT, `fee` = 2 USDT. С баланса спишется 102 USDT, получатель получит 100 USDT.

### `deduct_fee_from_amount: true`

- **Описание**: Комиссия вычитается из суммы перевода.
- **Логика**: Пользователь указывает в поле `amount` **общую** сумму, которую он готов потратить на вывод. Комиссия будет вычтена из этой суммы, а получатель получит остаток.
- **Пример**: `amount` = 100 USDT, `fee` = 2 USDT. С баланса спишется 100 USDT, получатель получит 98 USDT.

Клиентское приложение должно предоставить пользователю интерфейс для выбора одного из этих двух режимов.